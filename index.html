<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioDiet AI - Prototipo Final</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .main-card { border: none; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .result-box { background: white; padding: 30px; border-radius: 10px; margin-top: 20px; }
        .loading-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.9); z-index: 9999; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .day-card { transition: transform 0.2s; }
        .day-card:hover { transform: translateY(-5px); }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="spinner-border text-success" style="width: 3rem; height: 3rem;" role="status"></div>
    <h4 class="mt-3 text-success">Analizando Biometr√≠a con IA...</h4>
    <p class="text-muted">Calculando somatotipo y generando dieta personalizada</p>
</div>

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="fw-bold text-dark"><i class="fas fa-leaf text-success"></i> BioDiet AI</h1>
        <p class="lead text-muted">Nutrici√≥n Inteligente basada en Visi√≥n por Computadora</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-5 mb-4">
            <div class="card main-card p-4">
                <h4 class="mb-4 border-bottom pb-2"><i class="fas fa-user-edit"></i> Perfil del Paciente</h4>
                
                <form id="dietForm">
                    <div class="mb-4 p-3 bg-light rounded border border-primary">
                        <label class="form-label fw-bold text-primary"><i class="fas fa-camera"></i> Foto de Cuerpo Completo</label>
                        <input type="file" class="form-control" id="bodyImage" accept="image/*">
                        <div class="form-text small">Sube una foto frontal, pies juntos, brazos ligeramente separados.</div>
                    </div>

                    <div class="row g-3">
                        <div class="col-6">
                            <label>Edad</label>
                            <input type="number" class="form-control" id="age" value="24">
                        </div>
                        <div class="col-6">
                            <label>G√©nero</label>
                            <select class="form-select" id="gender">
                                <option value="male">Masculino</option>
                                <option value="female">Femenino</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label>Peso (kg)</label>
                            <input type="number" class="form-control" id="weight" value="75">
                        </div>
                        <div class="col-6">
                            <label>Estatura Real (cm)</label>
                            <input type="number" class="form-control" id="height" value="170">
                        </div>
                    </div>

                    <div class="mt-3">
                        <label>Nivel de Actividad</label>
                        <select class="form-select" id="activity">
                            <option value="sedentary">Sedentario (Oficina/Estudio)</option>
                            <option value="light">Ligero (1-3 d√≠as/sem)</option>
                            <option value="moderate" selected>Moderado (3-5 d√≠as/sem)</option>
                            <option value="active">Activo (Deportista)</option>
                        </select>
                    </div>

                    <div class="mt-3">
                        <label>Objetivo</label>
                        <select class="form-select" id="goal">
                            <option value="lose weight">Perder Grasa / Definir</option>
                            <option value="maintain">Mantenimiento / Salud</option>
                            <option value="gain muscle">Ganar Masa Muscular</option>
                        </select>
                    </div>

                    <div class="row mt-3 g-3">
                        <div class="col-6">
                            <label>Pa√≠s</label>
                            <input type="text" class="form-control" id="country" value="Bolivia">
                        </div>
                        <div class="col-6">
                            <label>Ciudad</label>
                            <input type="text" class="form-control" id="city" value="La Paz">
                        </div>
                    </div>

                    <div class="mt-3">
                        <label>Condiciones M√©dicas / Alergias</label>
                        <textarea class="form-control" id="conditions" rows="2" placeholder="Ej: Intolerancia a la lactosa, Diabetes...">Ninguna</textarea>
                    </div>

                    <div class="d-grid mt-4">
                        <button type="button" class="btn btn-success btn-lg shadow" onclick="generarDieta()">
                            Generar Plan Nutricional <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-7">
            <div id="resultContainer" class="d-none">
                
                <button class="btn btn-dark w-100 mb-3 shadow-sm" onclick="descargarPDF()">
                    <i class="fas fa-file-pdf me-2"></i> Descargar Plan en PDF
                </button>

                <div id="pdfContent" class="result-box shadow-sm position-relative">
                    
                    <div class="text-center border-bottom pb-3 mb-4">
                        <h2 class="text-success fw-bold">Plan Nutricional BioDiet</h2>
                        <p class="text-muted mb-1" id="pdfDate">Generado por IA</p>
                    </div>

                    <div class="card bg-light border-0 mb-4">
                        <div class="card-body">
                            <h5 class="text-primary fw-bold mb-3"><i class="fas fa-ruler-combined"></i> An√°lisis Antropom√©trico (IA)</h5>
                            <div class="row text-center">
                                <div class="col-4 border-end">
                                    <small class="text-muted">Somatotipo</small>
                                    <div class="fw-bold" id="resSomato">--</div>
                                    <small class="text-success" id="resScores">--</small>
                                </div>
                                <div class="col-4 border-end">
                                    <small class="text-muted">Medidas Est.</small>
                                    <div class="small">Hombros: <span id="resHombros" class="fw-bold">--</span> cm</div>
                                    <div class="small">Caderas: <span id="resCaderas" class="fw-bold">--</span> cm</div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Predicci√≥n (Mes)</small>
                                    <div class="fs-4 fw-bold text-success" id="resWeightChange">--</div>
                                    <small class="text-muted">Peso Final Est.</small>
                                </div>
                            </div>
                            <div class="mt-3 small fst-italic text-muted border-top pt-2" id="resSomatoDesc">
                                </div>
                        </div>
                    </div>

                    <div class="alert alert-success mb-4">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="fw-bold mb-1"><i class="fas fa-bullseye"></i> Meta Diaria</h6>
                                <div class="fs-5">
                                    <span id="resCalorias" class="fw-bold">--</span> kcal 
                                    <span class="fs-6 text-muted ms-2">
                                        (P: <span id="resProt"></span>g | C: <span id="resCarb"></span>g | G: <span id="resGrasa"></span>g)
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4 text-end small">
                                <i class="fas fa-piggy-bank"></i> Estrategia Econ√≥mica Aplicada
                            </div>
                        </div>
                        <div class="mt-2 small" id="resEstrategia"></div>
                    </div>

                    <h5 class="fw-bold mb-3 text-dark"><i class="fas fa-calendar-alt"></i> Ciclo Semanal (5+2)</h5>
                    <div id="dietPlanGrid">
                        </div>

                    <div class="mt-4 text-center text-muted small border-top pt-3">
                        <p><i class="fas fa-exclamation-triangle"></i> Este plan es generado por Inteligencia Artificial. Por favor consulta a un m√©dico antes de cambios dr√°sticos.</p>
                    </div>

                </div> </div>
            
            <div id="emptyState" class="text-center py-5 text-muted">
                <i class="fas fa-robot fa-4x mb-3 opacity-25"></i>
                <h4>Esperando datos...</h4>
                <p>Completa el formulario y sube una foto para comenzar.</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
    async function generarDieta() {
        const fileInput = document.getElementById('bodyImage');
        
        // Validaci√≥n b√°sica
        if (fileInput.files.length === 0) {
            alert("‚ö†Ô∏è Por favor, sube una foto de cuerpo completo para que la IA pueda medirte.");
            return;
        }

        // Mostrar Loader
        document.getElementById('loader').style.display = 'flex';

        // Crear FormData (Multipart)
        const formData = new FormData();
        
        // Agregamos los campos de texto uno por uno
        formData.append('age', document.getElementById('age').value);
        formData.append('gender', document.getElementById('gender').value);
        formData.append('current_weight_kg', document.getElementById('weight').value);
        formData.append('height_cm', document.getElementById('height').value);
        formData.append('activity_level', document.getElementById('activity').value);
        formData.append('goal', document.getElementById('goal').value);
        formData.append('country', document.getElementById('country').value);
        formData.append('city', document.getElementById('city').value);
        formData.append('medical_conditions', document.getElementById('conditions').value);
        
        // Agregamos el archivo
        formData.append('file', fileInput.files[0]);

        try {
            // Petici√≥n al Backend
            const response = await fetch('http://127.0.0.1:8000/generate-diet-with-image', {
                method: 'POST',
                body: formData // No pongas Content-Type header manualmente con FormData, el navegador lo hace
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || "Error al procesar la imagen");
            }

            const data = await response.json();
            renderizarResultados(data);

        } catch (error) {
            alert("‚ùå Error: " + error.message);
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }

    function renderizarResultados(data) {
        // Mostrar contenedor de resultados
        document.getElementById('emptyState').classList.add('d-none');
        document.getElementById('resultContainer').classList.remove('d-none');
        document.getElementById('pdfDate').innerText = new Date().toLocaleDateString();

        // 1. Llenar Biometr√≠a
        const prof = data.user_profile;
        const scores = prof.somatotype_scores;
        
        // Formatear scores (ej: 6.0 - 2.1 - 1.5)
        document.getElementById('resScores').innerText = `E:${scores.endo} M:${scores.meso} Ec:${scores.ecto}`;
        document.getElementById('resHombros').innerText = prof.biometrics.ancho_hombros_cm;
        document.getElementById('resCaderas').innerText = prof.biometrics.ancho_caderas_cm;
        
        // Interpretar somatotipo dominante para el t√≠tulo visual
        let tipo = "Balanceado";
        if (scores.endo > scores.meso && scores.endo > scores.ecto) tipo = "Endomorfo (Tendencia a acumular)";
        if (scores.meso > scores.endo && scores.meso > scores.ecto) tipo = "Mesomorfo (Atl√©tico)";
        if (scores.ecto > scores.endo && scores.ecto > scores.meso) tipo = "Ectomorfo (Delgado)";
        document.getElementById('resSomato').innerText = tipo;

        // Predicci√≥n
        const pred = data.prediction_4_weeks;
        const pesoFinal = pred.estimated_final_weight_kg;
        const pesoInicial = parseFloat(document.getElementById('weight').value);
        const cambio = pesoFinal - pesoInicial;
        const signo = cambio > 0 ? "+" : "";
        
        document.getElementById('resWeightChange').innerText = `${signo}${cambio.toFixed(1)} kg`;
        document.getElementById('resWeightChange').className = cambio < 0 ? "fs-4 fw-bold text-success" : "fs-4 fw-bold text-primary";

        // 2. Llenar Datos Dieta
        const diet = data.diet_plan;
        document.getElementById('resSomatoDesc').innerText = diet.analisis_inicial.interpretacion_somatotipo || "An√°lisis completado.";
        document.getElementById('resEstrategia').innerText = diet.analisis_inicial.estrategia_economica || "";
        
        document.getElementById('resCalorias').innerText = diet.resumen_nutricional.calorias_diarias_objetivo;
        document.getElementById('resProt').innerText = diet.resumen_nutricional.macros.proteina_g;
        document.getElementById('resCarb').innerText = diet.resumen_nutricional.macros.carbos_g;
        document.getElementById('resGrasa').innerText = diet.resumen_nutricional.macros.grasa_g;

        // 3. Renderizar Tarjetas de D√≠as
        const grid = document.getElementById('dietPlanGrid');
        grid.innerHTML = ''; // Limpiar anterior

        const plan = diet.plan_semanal_rotativo;
        
        for (const [key, meals] of Object.entries(plan)) {
            // Detectar si es d√≠a flexible
            const isFlexible = key.includes('flexible') || key.includes('6') || key.includes('7');
            const cardClass = isFlexible ? 'border-warning' : 'border-success';
            const headerClass = isFlexible ? 'bg-warning text-dark' : 'bg-success text-white';
            const icon = isFlexible ? '<i class="fas fa-unlock-alt"></i>' : '<i class="fas fa-check-circle"></i>';
            
            const diaNombre = key.replace(/_/g, ' ').replace('flexible', '(Flexible)').toUpperCase();

            const html = `
                <div class="card mb-3 day-card ${cardClass}">
                    <div class="card-header ${headerClass} fw-bold d-flex justify-content-between">
                        <span>${diaNombre}</span>
                        <span>${icon}</span>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0 small">
                            <li class="mb-2"><strong>üç≥ Desayuno:</strong> ${meals.desayuno}</li>
                            <li class="mb-2"><strong>ü•ó Almuerzo:</strong> ${meals.almuerzo}</li>
                            <li class="mb-2"><strong>üåô Cena:</strong> ${meals.cena}</li>
                            ${meals.snack ? `<li class="text-muted"><strong>üçé Snack:</strong> ${meals.snack}</li>` : ''}
                        </ul>
                    </div>
                </div>
            `;
            grid.innerHTML += html;
        }
        
        // Scroll
        document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
    }

    function descargarPDF() {
        const element = document.getElementById('pdfContent');
        const opt = {
            margin:       0.3,
            filename:     `Plan_BioDiet_${new Date().toISOString().slice(0,10)}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true },
            jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>

</body>
</html>